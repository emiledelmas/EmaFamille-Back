{% include 'base.html' %}
{% load static %}
{% load humanize %}
{% block head %}
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <link rel="stylesheet" href="Style.css">
    <link rel="stylesheet" href="Style_page_forum.css"/>
    <style>
        body {
            background-color: #eeeeee;
        }

        .h7 {
            font-size: 0.8rem;
        }

        .gedf-wrapper {
            margin-top: 0.97rem;
        }

        @media (min-width: 992px) {
            .gedf-main {
                padding-left: 4rem;
                padding-right: 4rem;
            }

            .gedf-card {
                margin-bottom: 2.77rem;
            }
        }

        /**Reset Bootstrap*/
        .dropdown-toggle::after {
            content: none;
            display: none;
        }
    </style>

{% endblock %}


{% block content %}
    <div class="text-center">
        <!-- Card Group with img as a social network feed in one column -->

        <nav class="navbar navbar-light bg-white">
            <a href="#" class="navbar-brand">EmaFamille</a>

            <form class="form-inline" method="post" action="{% url 'search' %}">
                {% csrf_token %}
                <input type="hidden" value="search" name="postType">
                <div class="input-group">
                    <input type="text" class="form-control" aria-label="Recipient's username"
                           aria-describedby="button-addon2" name="query">
                    <div class="input-group-append">
                        <button class="btn btn-outline-primary" type="submit" id="button-addon2">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>
                </div>
            </form>
        </nav>


        <div class="container-fluid gedf-wrapper">
            <div class="row">
                <div class="col-md-3">
                    <div class="card">

                        <div class="card-body">
                            {% if profile.photo %}
                                <img class="rounded-circle" width="200" src="{{ profile.photo.url }}" alt="">
                            {% endif %}
                            <br>
                            <div class="h5">@{{ user.username }}</div>
                            <div class="h7 text-muted">{{ user.first_name }} {{ user.last_name }}</div>
                            <div class="h7">Ceci est ma description</div>
                        </div>
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item">
                                <div class="h6 text-muted">Amis</div>
                                <div class="h5">{{profile.amis.count}}</div>
                            </li>
                        </ul>

                    </div>
                    <br>
                    <div class="col d-grip gap-2 align-items-start">

                        <div>
                            <a href="profile/" class="btn btn-primary ">
                                Accès Profil
                            </a>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 gedf-main">
                    <form method="post" enctype='multipart/form-data'>
                        {% csrf_token %}
                        <input type="hidden" value="postFeed" name="postType">
                        <!--- \\\\\\\Post-->
                        <div class="card gedf-card">
                            <div class="card-header">
                                <ul class="nav nav-tabs card-header-tabs" id="myTab" role="tablist">
                                    <li class="nav-item">
                                        <a class="nav-link active" id="posts-tab" data-toggle="tab" href="#posts"
                                           role="tab" aria-controls="posts" aria-selected="true">Faire une
                                            publication</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" id="images-tab" data-toggle="tab" role="tab"
                                           aria-controls="images" aria-selected="false" href="#images">Images</a>
                                    </li>
                                </ul>
                            </div>
                            <div class="card-body">
                                <div class="tab-content" id="myTabContent">
                                    <div class="tab-pane fade show active" id="posts" role="tabpanel"
                                         aria-labelledby="posts-tab">
                                        <div class="form-group">
                                            <label class="sr-only" for="message">post</label>
                                            <textarea class="form-control" id="message" rows="3"
                                                      placeholder="A quoi pensez-vous?" name="texte"></textarea>
                                        </div>

                                    </div>
                                    <div class="tab-pane fade" id="images" role="tabpanel" aria-labelledby="images-tab">
                                        <div class="form-group">
                                            <div class="custom-file">
                                                <input type="file" class="custom-file-input" id="customFile"
                                                       name="image">
                                                <label class="custom-file-label" for="customFile">Uploader
                                                    l'image</label>
                                            </div>
                                        </div>
                                        <div class="py-4"></div>
                                    </div>
                                </div>
                                <div class="btn-toolbar justify-content-between">
                                    <div class="btn-group">
                                        <button type="submit" class="btn btn-primary">Publier</button>
                                    </div>
                                    <div class="btn-group">
                                        <button id="btnGroupDrop1" type="button" class="btn btn-link dropdown-toggle"
                                                data-toggle="dropdown" aria-haspopup="true"
                                                aria-expanded="false">
                                            <i class="fa fa-globe"></i>
                                        </button>
                                        <div class="dropdown-menu dropdown-menu-right" aria-labelledby="btnGroupDrop1">
                                            <a class="dropdown-item" href="#"><i class="fa fa-globe"></i> Public</a>
                                            <a class="dropdown-item" href="#"><i class="fa fa-users"></i> Famille</a>
                                            <a class="dropdown-item" href="#"><i class="fa fa-user"></i> Amis</a>
                                        </div>
                                    </div>
                                </div>

                            </div>

                        </div>
                    </form>

                    <!-- Post /////-->
                    {% if query %}
                        <div class="card-body">

                            <p class="card-text">
                                Résultats de la recherche de "{{ query }}"
                            </p>
                        </div>
                    {% endif %}
                    {% for post in Posts_Feed %}
                        <!--- \\\\\\\Post-->
                        <div class="card gedf-card">
                            <div class="card-header">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="mr-2">
                                            <img class="rounded-circle" width="45" src="Photo_Emile.JPG" alt="">
                                        </div>
                                        <div class="ml-2">
                                            <div class="h5 m-0">@{{ post.auteur }}</div>
                                            <div class="h7 text-muted">{{ post.auteur }}</div>
                                        </div>
                                    </div>
                                    <div>
                                        <div class="dropdown">
                                            <button class="btn btn-link dropdown-toggle" type="button"
                                                    data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                                <i class="fa fa-ellipsis-h"></i>
                                            </button>
                                            <div class="dropdown-menu dropdown-menu-right" aria-labelledby="gedf-drop1">
                                                <div class="h6 dropdown-header">Configuration</div>
                                                <a class="dropdown-item" href="#">Save</a>
                                                <a class="dropdown-item" href="#">Hide</a>
                                                <a class="dropdown-item" href="#">Report</a>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                            </div>
                            <div class="card-body">
                                {% if post.image %}
                                    <img src="{{ post.image.url }}" class="img-fluid" alt="image desc">
                                {% endif %}
                                <div class="text-muted h7 mb-2 align-items-center"><i
                                        class="fa fa-clock-o"></i> {{ post.date| naturaltime }} </div>
                                <a class="card-link" href="#">
                                    <h5 class="card-title text-dark"></h5>
                                </a>

                                <p class="card-text">
                                    {{ post.texte|linebreaks }}
                                </p>
                            </div>
                            <div class="card-footer">
                            {% comment %} <form action="{% url 'like' %}" method="post" id="likeForm{{ post.id }}">
                                {% csrf_token %}
                                <input type="hidden" name="post_id" value="{{ post.id }}">
                                <a href="javascript:void(0);" onclick="document.getElementById('likeForm{{ post.id }}').submit();" class="card-link" style="{% if user not in post.likes.all %}color:grey;{% endif %}">
                                    <i class="fa fa-thumbs-up"></i> {{ post.likes.count }} Like{{ post.likes.count|pluralize }}
                                </a>
                                <a href="" class="card-link" style="color:grey;"><i class="fa fa-comment"></i> Comment</a>
                                <a href="" class="card-link" style="color:grey;"><i class="fa fa-mail-forward"></i> Share</a>
                            </form> {% endcomment %}
                    


                            <a href="javascript:void(0)" class="card-link" id="like{{ post.id }}" {% if user not in post.likes.all %}style="color:grey;"{% endif %}>
                                    <i class="fa fa-thumbs-up"></i> 
                                    {{ post.likes.count }} Like{{ post.likes.count|pluralize }}
                                   
                                </a>
                                <a href="javascript:void(0)" class="card-link" style="color:grey;" id="comment{{ post.id }}"><i class="fa fa-comment"></i> Comment</a>
                                <a href="" class="card-link" style="color:grey;"><i class="fa fa-mail-forward"></i> Share</a>
                               <textarea class="form-control" id="commentTextArea{{ post.id }}" rows="3" style="display:none;margin-top:10px"></textarea>
                                <script>

                                    const csrftoken{{ post.id }} = '{{ csrf_token }}'
                                    
                                    document.getElementById('like{{ post.id }}').onclick = () => {
                                
                                        const requestObj = new XMLHttpRequest()
                                        requestObj.onreadystatechange = function () {
                                            if (this.readyState == 4 && this.status == 200) {
                                                console.log(this.responseText)
                                                if (this.responseText[0] == '1') {
                                                    document.getElementById('like{{ post.id }}').style.color = '#007bff';
                                                } else {
                                                    document.getElementById('like{{ post.id }}').style.color = 'grey';
                                                }
                                                let likesCount = this.responseText.split("-")[1].trim(); // extract the second number after "-"
                                                let pluralizeLikeWord = (likesCount == 1) ? " Like" : " Likes"; // pluralize the word "Like"
                                                document.getElementById('like{{ post.id }}').innerHTML = '<i class="fa fa-thumbs-up"></i> '+ likesCount + pluralizeLikeWord; // update the number of likes
                                            }
                                        }
                    
                                        requestObj.open("POST", "{% url 'like' %}")
                                        requestObj.setRequestHeader("X-CSRFToken", csrftoken{{ post.id }})
                        
                                        const formdata = new FormData()
                                        formdata.append('post_id', '{{ post.id }}')
                                        requestObj.send(formdata)
                                    }


                                    document.getElementById('comment{{ post.id }}').onclick = () => {
                                        document.getElementById('commentTextArea{{ post.id }}').style.display = 'block';
                                    }
                                </script>
                            </div>
                        </div>
                        <!-- Post /////-->
                    {% endfor %}


                </div>
                <div class="col-md-3">
                    <div class="card gedf-card">
                        <div class="card-body">
                            <h5 class="card-title"> Ma Famille </h5>
                            <h6 class="card-subtitle mb-2 text-muted"> {{ famille.name }} </h6>
                            <p class="card-text">{{ famille.description }} </p>
                            <br/>
                            {% if famille.logo %}
                                <img class="rounded-circle" width="200" src="{{ famille.logo.url }}" alt="">
                            {% endif %}
                            <br/>
                            <br/>
                            <a href="famille" class="card-link">Profil de famille</a>
                            <a href="#" class="card-link"><i class="fa fa-google-drive"></i> Drive</a>
                        </div>
                    </div>
                    <div class="card gedf-card">
                        <div class="card-body">
                            <h5 class="card-title">ajout rapide </h5>
                            <h6 class="card-subtitle mb-2 text-muted">ajoute ces BG </h6>
                            {% for profile in ajout %}
                                <div class="card gedf-card">
                                    <div class="card-body">
                                        {% if profile.photo %}
                                        <img class="rounded-circle" width="50" src="{{ profile.photo.url }}" alt="">
                                        {% endif %}
                                        <p class="card-text h5">@{{ profile.user.username }}</p>
                                      <form action="{% url 'ajout_rapide' %}" method="post" id="ajout_rapide{{ profile.id }}">
                                {% csrf_token %}
                                <input type="hidden" name="user_id" value="{{ profile.user.id }}">
                                 <a href="javascript:void(0);" onclick="document.getElementById('ajout_rapide{{ profile.id }}').submit();"  class="btn btn-primary boutons">
                                            Ajouter
                                        </a>
                            </form>

                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"
          integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN"
          crossorigin="anonymous">

    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
            integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"
            integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
            crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"
            integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
            crossorigin="anonymous"></script>
<script>
    document.addEventListener("DOMContentLoaded", function(event) { 
        var scrollpos = localStorage.getItem('scrollpos');
        if (scrollpos) window.scrollTo(0, scrollpos);
    });

    window.onbeforeunload = function(e) {
        localStorage.setItem('scrollpos', window.scrollY);
    };
</script>

{% endblock content %}